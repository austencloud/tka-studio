<!--
GeneratePanel.svelte - Clean, focused generation panel component

Refactored into smaller section components for better maintainability:
- Header: GeneratePanelHeader.svelte
- Settings: SettingsContainer.svelte (which includes individual sections)
- Actions: ActionSection.svelte
- Config state moved to generateConfigState.svelte.ts
- Generation actions moved to generateActionsState.svelte.ts
- Device state moved to generateDeviceState.svelte.ts
- Maintains all original functionality with cleaner separation
-->
<script lang="ts">
  import { CAP_TYPE_LABELS } from "$build/generate/circular";
  import type { IHapticFeedbackService } from "$shared";
  import { resolve, TYPES } from "$shared";
  import { onMount } from "svelte";
// Import section components
  import type { IDeviceDetector } from "../../../../shared/device/services/contracts";
  import type { SequenceState } from "../../shared/state";
  import { createDeviceState, createGenerationActionsState, createGenerationConfigState, createPresetState } from "../state";
  import type { GenerationPreset } from "../state/preset.svelte";
  import ActionSection from "./ActionSection.svelte";
  import CardBasedSettingsContainer from "./CardBasedSettingsContainer.svelte";
  import EditPresetModal from "./modals/EditPresetModal.svelte";
  import PresetSelectionModal from "./modals/PresetSelectionModal.svelte";
  import SavePresetModal from "./modals/SavePresetModal.svelte";
// Import simple state managers

  // Props
  let { sequenceState }: { sequenceState: SequenceState } = $props();

  // Services
  let hapticService: IHapticFeedbackService;

  // Auto-generate preset name from config
  function generatePresetName(): string {
    const config = configState.config;
    const capType = CAP_TYPE_LABELS[config.capType as keyof typeof CAP_TYPE_LABELS] || config.capType;
    const gridMode = config.gridMode.charAt(0).toUpperCase() + config.gridMode.slice(1);

    return `${capType} ${config.length} ${gridMode}`;
  }

  // Animation is always sequential with gentle bloom
  const isSequentialAnimation = true;

  // ===== State Management =====
  const configState = createGenerationConfigState();
  const actionsState = createGenerationActionsState(
    sequenceState,
    () => isSequentialAnimation
  );
  const deviceState = createDeviceState();
  const presetState = createPresetState();

  // ===== Preset Modal State =====
  let showPresetModal = $state(false);
  let showSaveModal = $state(false);
  let showEditModal = $state(false);
  let editingPreset = $state<GenerationPreset | null>(null);

  // ===== Preset Handlers =====
  function handleOpenPresetModal() {
    hapticService?.trigger("selection");
    showPresetModal = true;
  }

  function handleOpenSaveModal() {
    hapticService?.trigger("selection");
    showSaveModal = true;
  }

  function handleLoadPreset(preset: GenerationPreset) {
    configState.updateConfig(preset.config);
    showPresetModal = false;
  }

  function handleSavePreset(icon?: string) {
    const autoGeneratedName = generatePresetName();
    presetState.savePreset(autoGeneratedName, configState.config, icon);
    showSaveModal = false;
  }

  function handleEditPreset(preset: GenerationPreset) {
    editingPreset = preset;
    showEditModal = true;
  }

  function handleSaveEditedPreset(name: string, icon?: string) {
    if (editingPreset) {
      presetState.updatePreset(editingPreset.id, { name, icon });
      showEditModal = false;
      editingPreset = null;
    }
  }

  function handleDeletePreset(presetId: string) {
    presetState.deletePreset(presetId);
  }

  // ===== Device Service Integration =====
  onMount(() => {
    // Resolve haptic service
    hapticService = resolve<IHapticFeedbackService>(TYPES.IHapticFeedbackService);

    try {
      const deviceService = resolve<IDeviceDetector>(TYPES.IDeviceDetector);
      return deviceState.initializeDevice(deviceService);
    } catch (error) {
      console.log("GeneratePanel: Device service not ready yet:", error);
      // Fallback handled in deviceState
      return undefined;
    }
  });
</script>

<div
  class="generate-panel"
  data-layout={deviceState.layoutMode}
  data-allow-scroll={deviceState.shouldAllowScrolling}
  style="--min-touch-target: {deviceState.minTouchTarget}px; --element-spacing: {deviceState.elementSpacing}px;"
>
  <!-- Preset Buttons -->
  <div class="preset-actions">
    <button
      class="preset-button"
      onclick={handleOpenPresetModal}
      disabled={!presetState.hasPresets}
      title={presetState.hasPresets ? "Load preset" : "No saved presets"}
    >
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 3h18v18H3z"></path>
        <path d="M9 9h6M9 12h6M9 15h6"></path>
      </svg>
      <span>Presets</span>
    </button>

    <button
      class="preset-button"
      onclick={handleOpenSaveModal}
      title="Save current settings as preset"
    >
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
        <polyline points="17 21 17 13 7 13 7 21"></polyline>
        <polyline points="7 3 7 8 15 8"></polyline>
      </svg>
      <span>Save</span>
    </button>
  </div>

  <CardBasedSettingsContainer
    config={configState.config}
    isFreeformMode={configState.isFreeformMode}
    updateConfig={configState.updateConfig}
  />

  <ActionSection
    onGenerateClicked={actionsState.onGenerateClicked}
    config={configState.config}
    isGenerating={actionsState.isGenerating}
  />
</div>

<!-- Modals -->
{#if showPresetModal}
  <PresetSelectionModal
    presets={presetState.presets}
    onPresetSelect={handleLoadPreset}
    onPresetDelete={handleDeletePreset}
    onPresetEdit={handleEditPreset}
    onClose={() => showPresetModal = false}
  />
{/if}

{#if showSaveModal}
  <SavePresetModal
    onSave={handleSavePreset}
    onClose={() => showSaveModal = false}
  />
{/if}

{#if showEditModal && editingPreset}
  <EditPresetModal
    preset={editingPreset}
    onSave={handleSaveEditedPreset}
    onClose={() => {
      showEditModal = false;
      editingPreset = null;
    }}
  />
{/if}

<!-- Main panel styling only - child components handle their own styles -->
<style>
  .generate-panel {
    /* No position property - allows modals to position relative to right-panel ancestor */
    display: flex;
    flex-direction: column;
    height: 100%;
    padding: var(--element-spacing);
    border-radius: 8px;
    font-family: "Segoe UI", sans-serif;
    overflow: hidden;
    gap: calc(var(--element-spacing) );
  }


  /* Ensure no scrolling is forced when not appropriate */
  .generate-panel[data-allow-scroll="false"] {
    overflow: hidden;
  }


  /* Landscape mobile: Reduce padding for ultra-compact mode */


  /* Preset Actions */
  .preset-actions {
    display: flex;
    flex-shrink: 0;
    gap: var(--element-spacing);
  }

  .preset-button {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 16px;

    /* Subtle gradient background - secondary action style */
    background: linear-gradient(135deg, rgba(102, 126, 234, 1) 0%, rgba(118, 75, 162, 1) 100%);
    border: 1px solid rgba(255, 255, 255, 0.2);

    /* Modern 16px border-radius */
    border-radius: 16px;

    color: white;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;

    /* Smooth cubic-bezier transition */
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);

    min-height: 40px;

    /* Layered shadows for depth - matching Generate button */
    box-shadow:
      0 1px 2px hsl(0deg 0% 0% / 0.12),
      0 2px 4px hsl(0deg 0% 0% / 0.12),
      0 4px 8px hsl(0deg 0% 0% / 0.12);
  }

  .preset-button:hover:not(:disabled) {
    /* Brighter on hover */
    filter: brightness(1.1);
    color: white;

    /* Lift effect */
    transform: translateY(-2px);

    /* Enhanced elevation on hover */
    box-shadow:
      0 2px 4px hsl(0deg 0% 0% / 0.1),
      0 4px 8px hsl(0deg 0% 0% / 0.1),
      0 8px 16px hsl(0deg 0% 0% / 0.1),
      0 16px 24px hsl(0deg 0% 0% / 0.08);
  }

  .preset-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .preset-button svg {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
  }

  .preset-button span {
    white-space: nowrap;
  }
</style>
