<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animation Data Analyzer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        .upload-section {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        .upload-box {
            flex: 1;
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f9f9f9;
        }
        .upload-box.has-data {
            border-color: #28a745;
            background: #d4edda;
        }
        .upload-box input[type="file"] {
            margin: 10px 0;
        }
        .analysis-section {
            margin-top: 30px;
        }
        .results {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .difference-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .difference-table th,
        .difference-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .difference-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .difference-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        .significant-diff {
            background: #fff3cd !important;
            color: #856404;
        }
        .major-diff {
            background: #f8d7da !important;
            color: #721c24;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-box {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Animation Data Analyzer</h1>
            <p>Compare animation logging data from standalone and Browse tab systems</p>
        </div>

        <div class="upload-section">
            <div class="upload-box" id="standaloneBox">
                <h3>Standalone Animation Data</h3>
                <p>Upload JSON file from standalone animator with logging</p>
                <input type="file" id="standaloneFile" accept=".json" />
                <div id="standaloneStatus">No file selected</div>
            </div>

            <div class="upload-box" id="browseBox">
                <h3>Browse Tab Animation Data</h3>
                <p>Upload JSON file from Browse tab animation test</p>
                <input type="file" id="browseFile" accept=".json" />
                <div id="browseStatus">No file selected</div>
            </div>
        </div>

        <div class="analysis-section">
            <button id="analyzeBtn" disabled>Analyze Differences</button>
            <button id="exportBtn" disabled>Export Analysis Report</button>
            
            <div id="results" style="display: none;">
                <div class="results">
                    <h3>Analysis Summary</h3>
                    <div class="stats" id="statsContainer">
                        <!-- Stats will be populated here -->
                    </div>
                </div>

                <div class="results">
                    <h3>Significant Differences (> 0.01)</h3>
                    <div id="differencesContainer">
                        <!-- Differences table will be populated here -->
                    </div>
                </div>

                <div class="results">
                    <h3>Beat-by-Beat Comparison</h3>
                    <div id="beatComparisonContainer">
                        <!-- Beat comparison will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Animation Data Analyzer Implementation
        class AnimationDataAnalyzer {
            constructor() {
                this.standaloneData = null;
                this.browseData = null;
                this.analysisResults = null;
                
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                document.getElementById('standaloneFile').addEventListener('change', (e) => {
                    this.loadFile(e.target.files[0], 'standalone');
                });
                
                document.getElementById('browseFile').addEventListener('change', (e) => {
                    this.loadFile(e.target.files[0], 'browse');
                });
                
                document.getElementById('analyzeBtn').addEventListener('click', () => {
                    this.analyzeData();
                });
                
                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportReport();
                });
            }
            
            async loadFile(file, type) {
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    if (type === 'standalone') {
                        this.standaloneData = data;
                        document.getElementById('standaloneStatus').textContent = 
                            `Loaded: ${data.entries?.length || 0} entries`;
                        document.getElementById('standaloneBox').classList.add('has-data');
                    } else {
                        this.browseData = data;
                        document.getElementById('browseStatus').textContent = 
                            `Loaded: ${data.entries?.length || 0} entries`;
                        document.getElementById('browseBox').classList.add('has-data');
                    }
                    
                    // Enable analyze button if both files are loaded
                    if (this.standaloneData && this.browseData) {
                        document.getElementById('analyzeBtn').disabled = false;
                    }
                    
                } catch (error) {
                    this.showError(`Failed to load ${type} file: ${error.message}`);
                }
            }
            
            analyzeData() {
                if (!this.standaloneData || !this.browseData) {
                    this.showError('Please load both data files first');
                    return;
                }
                
                try {
                    const standaloneEntries = this.standaloneData.entries || [];
                    const browseEntries = this.browseData.entries || [];
                    
                    this.analysisResults = this.compareAnimationData(standaloneEntries, browseEntries);
                    this.displayResults();
                    
                    document.getElementById('exportBtn').disabled = false;
                    
                } catch (error) {
                    this.showError(`Analysis failed: ${error.message}`);
                }
            }
            
            compareAnimationData(standaloneEntries, browseEntries) {
                const differences = [];
                const tolerance = 0.001; // Very small tolerance for floating point comparison
                const significantTolerance = 0.01; // Threshold for significant differences
                
                let totalComparisons = 0;
                let significantDifferences = 0;
                let maxDifference = 0;
                let totalDifference = 0;
                
                // Find matching frames by beat (approximately)
                const beatTolerance = 0.01;
                
                for (const standaloneEntry of standaloneEntries) {
                    // Find corresponding browse entry
                    const browseEntry = browseEntries.find(
                        entry => Math.abs(entry.beat - standaloneEntry.beat) < beatTolerance
                    );
                    
                    if (!browseEntry) continue;
                    
                    // Compare all numeric properties
                    const comparisons = [
                        { prop: 'blue_centerPathAngle', standalone: standaloneEntry.blue.centerPathAngle, browse: browseEntry.blue.centerPathAngle },
                        { prop: 'blue_staffRotationAngle', standalone: standaloneEntry.blue.staffRotationAngle, browse: browseEntry.blue.staffRotationAngle },
                        { prop: 'blue_x', standalone: standaloneEntry.blue.x, browse: browseEntry.blue.x },
                        { prop: 'blue_y', standalone: standaloneEntry.blue.y, browse: browseEntry.blue.y },
                        { prop: 'red_centerPathAngle', standalone: standaloneEntry.red.centerPathAngle, browse: browseEntry.red.centerPathAngle },
                        { prop: 'red_staffRotationAngle', standalone: standaloneEntry.red.staffRotationAngle, browse: browseEntry.red.staffRotationAngle },
                        { prop: 'red_x', standalone: standaloneEntry.red.x, browse: browseEntry.red.x },
                        { prop: 'red_y', standalone: standaloneEntry.red.y, browse: browseEntry.red.y },
                    ];
                    
                    for (const comp of comparisons) {
                        const diff = Math.abs(comp.standalone - comp.browse);
                        totalDifference += diff;
                        totalComparisons++;
                        
                        if (diff > maxDifference) {
                            maxDifference = diff;
                        }
                        
                        if (diff > significantTolerance) {
                            significantDifferences++;
                            differences.push({
                                beat: standaloneEntry.beat,
                                property: comp.prop,
                                standaloneValue: comp.standalone,
                                browseValue: comp.browse,
                                difference: diff,
                                frameNumber: standaloneEntry.frameNumber,
                            });
                        }
                    }
                }
                
                return {
                    differences,
                    summary: {
                        totalFramesCompared: Math.floor(totalComparisons / 8), // 8 properties per frame
                        totalComparisons,
                        maxDifference,
                        averageDifference: totalComparisons > 0 ? totalDifference / totalComparisons : 0,
                        significantDifferences,
                        matchingFrames: standaloneEntries.filter(se => 
                            browseEntries.some(be => Math.abs(be.beat - se.beat) < beatTolerance)
                        ).length,
                    },
                };
            }
            
            displayResults() {
                const results = this.analysisResults;
                
                // Show results section
                document.getElementById('results').style.display = 'block';
                
                // Display summary stats
                const statsContainer = document.getElementById('statsContainer');
                statsContainer.innerHTML = `
                    <div class="stat-box">
                        <div class="stat-value">${results.summary.totalFramesCompared}</div>
                        <div class="stat-label">Frames Compared</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${results.summary.significantDifferences}</div>
                        <div class="stat-label">Significant Differences</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${results.summary.maxDifference.toFixed(6)}</div>
                        <div class="stat-label">Max Difference</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${results.summary.averageDifference.toFixed(6)}</div>
                        <div class="stat-label">Average Difference</div>
                    </div>
                `;
                
                // Display differences table
                const differencesContainer = document.getElementById('differencesContainer');
                if (results.differences.length === 0) {
                    differencesContainer.innerHTML = '<p class="success">No significant differences found! The animations match closely.</p>';
                } else {
                    let tableHTML = `
                        <table class="difference-table">
                            <thead>
                                <tr>
                                    <th>Beat</th>
                                    <th>Property</th>
                                    <th>Standalone Value</th>
                                    <th>Browse Value</th>
                                    <th>Difference</th>
                                    <th>Frame #</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    // Sort differences by magnitude
                    const sortedDiffs = results.differences.sort((a, b) => b.difference - a.difference);
                    
                    for (const diff of sortedDiffs.slice(0, 50)) { // Show top 50 differences
                        const rowClass = diff.difference > 0.1 ? 'major-diff' : 
                                       diff.difference > 0.05 ? 'significant-diff' : '';
                        
                        tableHTML += `
                            <tr class="${rowClass}">
                                <td>${diff.beat.toFixed(3)}</td>
                                <td>${diff.property}</td>
                                <td>${diff.standaloneValue.toFixed(6)}</td>
                                <td>${diff.browseValue.toFixed(6)}</td>
                                <td>${diff.difference.toFixed(6)}</td>
                                <td>${diff.frameNumber}</td>
                            </tr>
                        `;
                    }
                    
                    tableHTML += '</tbody></table>';
                    
                    if (sortedDiffs.length > 50) {
                        tableHTML += `<p><em>Showing top 50 of ${sortedDiffs.length} differences. Export full report for complete data.</em></p>`;
                    }
                    
                    differencesContainer.innerHTML = tableHTML;
                }
            }
            
            exportReport() {
                if (!this.analysisResults) return;
                
                const report = {
                    timestamp: new Date().toISOString(),
                    summary: this.analysisResults.summary,
                    differences: this.analysisResults.differences,
                    standaloneDataInfo: {
                        system: this.standaloneData.system,
                        totalFrames: this.standaloneData.totalFrames,
                        startTime: this.standaloneData.startTime,
                        endTime: this.standaloneData.endTime,
                    },
                    browseDataInfo: {
                        system: this.browseData.system,
                        totalFrames: this.browseData.totalFrames,
                        startTime: this.browseData.startTime,
                        endTime: this.browseData.endTime,
                    },
                };
                
                const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `animation-comparison-report-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.showSuccess('Analysis report exported successfully');
            }
            
            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = message;
                document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.upload-section'));
                
                setTimeout(() => errorDiv.remove(), 5000);
            }
            
            showSuccess(message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'success';
                successDiv.textContent = message;
                document.querySelector('.container').insertBefore(successDiv, document.querySelector('.upload-section'));
                
                setTimeout(() => successDiv.remove(), 3000);
            }
        }
        
        // Initialize the analyzer when DOM is ready
        window.addEventListener('DOMContentLoaded', () => {
            window.animationAnalyzer = new AnimationDataAnalyzer();
        });
    </script>
</body>
</html>
