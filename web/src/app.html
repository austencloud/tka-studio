<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%sveltekit.assets%/favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#1a1a1a" />

    <!-- CACHE MANAGEMENT - Clear stale cache on startup -->
    <script>
      (function () {
        try {
          // Always clear cache-related items on startup to prevent quota issues
          const keysToRemove = [];
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (
              key &&
              (key.includes("preload") ||
                key.includes("options") ||
                key.includes("cache") ||
                key.includes("all_preloaded_options") ||
                key.includes("preloaded_options_meta"))
            ) {
              keysToRemove.push(key);
            }
          }

          keysToRemove.forEach((key) => {
            localStorage.removeItem(key);
          });

          // Double-check total size after clearing
          let totalSize = 0;
          for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
              totalSize += localStorage[key].length + key.length;
            }
          }
        } catch (error) {
          console.warn("Failed to check/clear cache on startup:", error);
        }
      })();

      // Development Storage Cleanup Utilities
      if (
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1"
      ) {
        window.clearTKAStorage = function () {
          const keys = [];
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith("tka-")) {
              keys.push(key);
            }
          }
          keys.forEach((key) => {
            localStorage.removeItem(key);
          });

          // Clear other TKA-related keys
          const otherKeys = [
            "optionPickerSortMethod",
            "lastSelectedTab",
            "preloaded_options",
            "all_preloaded_options",
            "tka-modern-web-settings",
          ];
          otherKeys.forEach((key) => {
            if (localStorage.getItem(key)) {
              localStorage.removeItem(key);
            }
          });
        };

        window.clearSequences = function () {
          const keys = [];
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (
              key &&
              (key.includes("-sequence") || key.includes("-sequences"))
            ) {
              keys.push(key);
            }
          }
          keys.forEach((key) => {
            localStorage.removeItem(key);
          });
        };
      }
    </script>

    <!-- SMART CONSOLE FORWARDER - DEVELOPMENT ONLY -->
    <script>
      (function () {
        // Only enable in development
        const isDev =
          window.location.hostname === "localhost" ||
          window.location.hostname === "127.0.0.1";
        if (!isDev) return;

        // Store original console methods
        const originalConsole = {
          log: console.log,
          error: console.error,
          warn: console.warn,
          info: console.info,
        };

        // Filter out noisy logs
        function shouldForwardLog(args) {
          const message = args.join(" ");

          // Skip empty or whitespace-only messages
          if (!message.trim()) return false;

          // Skip single numbers without context
          if (args.length === 1 && typeof args[0] === "number") return false;

          // Skip very short messages that are likely debug noise
          if (message.length < 3) return false;

          // Skip repetitive debug messages
          const skipPatterns = [
            /^[0-9]+$/, // Just numbers
            /^\s*$/, // Just whitespace
            /^undefined$/,
            /^null$/,
          ];

          return !skipPatterns.some((pattern) => pattern.test(message));
        }

        // Send to server (throttled)
        let lastLogTime = 0;
        const LOG_THROTTLE_MS = 100; // Minimum time between logs

        function sendToServer(level, args) {
          const now = Date.now();
          if (now - lastLogTime < LOG_THROTTLE_MS) return;
          lastLogTime = now;

          if (!shouldForwardLog(args)) return;

          // ULTRA SIMPLE: Just convert everything to string and capture what the browser actually shows
          let message = "";
          try {
            // Capture the exact same output that would appear in browser console
            const parts = [];
            for (let i = 0; i < args.length; i++) {
              const arg = args[i];
              if (arg && typeof arg === "object" && arg.message) {
                // This looks like an Error object - get the actual error message
                parts.push(`${arg.name || "Error"}: ${arg.message}`);
                if (arg.stack) {
                  parts.push(`\nStack: ${arg.stack}`);
                }
              } else {
                // For everything else, just use String() which is what console does
                parts.push(String(arg));
              }
            }
            message = parts.join(" ");
          } catch (e) {
            message = `[Console forwarding error: ${e.message}] Raw args: ${args.length} items`;
          }

          fetch("/api/console-log", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              level,
              message,
              timestamp: new Date().toISOString(),
            }),
          }).catch(() => {}); // Ignore fetch errors
        }

        // Override console methods with smart filtering
        console.log = function (...args) {
          originalConsole.log.apply(console, args);
          sendToServer("LOG", args);
        };

        console.error = function (...args) {
          originalConsole.error.apply(console, args);
          sendToServer("ERROR", args);
        };

        console.warn = function (...args) {
          originalConsole.warn.apply(console, args);
          sendToServer("WARN", args);
        };

        console.info = function (...args) {
          originalConsole.info.apply(console, args);
          sendToServer("INFO", args);
        };

        // Capture global errors (always forward these)
        window.addEventListener("error", function (event) {
          console.error("ðŸš¨ GLOBAL ERROR:", {
            message: event.message,
            filename: event.filename,
            line: event.lineno,
            column: event.colno,
            stack: event.error?.stack,
          });
        });

        // Capture unhandled promise rejections (always forward these)
        window.addEventListener("unhandledrejection", function (event) {
          console.error("ðŸš¨ UNHANDLED PROMISE REJECTION:", event.reason);
        });
      })();
    </script>

    <!-- BACKGROUND PRELOADER - Load saved background immediately to prevent default gradient flash -->
    <script>
      (function () {
        try {
          // Load saved settings
          const settingsKey = "tka-modern-web-settings";
          const stored = localStorage.getItem(settingsKey);

          if (stored) {
            const settings = JSON.parse(stored);
            const backgroundType = settings.backgroundType || "nightSky";

            // Background gradients mapping - same as background-config.ts
            const backgroundGradients = {
              aurora:
                "linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%)",
              snowfall:
                "linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)",
              nightSky:
                "linear-gradient(135deg, #0a0e2c 0%, #1a2040 50%, #2a3060 100%)",
              bubbles:
                "linear-gradient(135deg, #143250 0%, #0a1e3c 50%, #050f28 100%)",
              deepOcean:
                "linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)",
            };

            // Background animation mapping - same as background-config.ts
            const backgroundAnimations = {
              aurora: "aurora-flow",
              snowfall: "snow-fall",
              nightSky: "star-twinkle",
              bubbles: "bubble-float",
              deepOcean: "bubble-float", // Use bubble-float for deep ocean
            };

            const selectedGradient =
              backgroundGradients[backgroundType] ||
              backgroundGradients.nightSky;

            const selectedAnimation =
              backgroundAnimations[backgroundType] ||
              backgroundAnimations.nightSky;

            // Update the CSS custom property immediately
            document.documentElement.style.setProperty(
              "--gradient-cosmic",
              selectedGradient
            );

            // Apply animation class to body when DOM is ready
            function applyBackgroundAnimation() {
              const body = document.body;
              if (body) {
                // Remove any existing background animation classes
                body.classList.remove(
                  "aurora-flow",
                  "snow-fall",
                  "star-twinkle",
                  "bubble-float"
                );
                // Add the selected animation class
                body.classList.add(selectedAnimation);
                console.log(
                  "ðŸŒŸ Background animation applied:",
                  selectedAnimation
                );
              } else {
                // If body isn't ready yet, try again in a moment
                setTimeout(applyBackgroundAnimation, 10);
              }
            }

            // Apply animation immediately if DOM is ready, otherwise wait
            if (document.body) {
              applyBackgroundAnimation();
            } else {
              document.addEventListener(
                "DOMContentLoaded",
                applyBackgroundAnimation
              );
            }

            console.log("ðŸŽ¨ Background preloaded:", backgroundType);
          } else {
            console.log("ðŸŽ¨ No saved background found, using default");
          }
        } catch (error) {
          console.warn("Failed to preload background:", error);
        }
      })();
    </script>

    <!-- Preload critical fonts if needed -->
    <!-- <link rel="preload" href="/fonts/inter.woff2" as="font" type="font/woff2" crossorigin> -->

    %sveltekit.head%
  </head>
  <body
    data-sveltekit-preload-data="hover"
    class="bg-background text-foreground"
  >
    <div style="display: contents">%sveltekit.body%</div>
  </body>
</html>
